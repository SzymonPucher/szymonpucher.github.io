---
import Layout from '../../layouts/BlogPost.astro';
import { languages } from '../../i18n/ui';
import aboutImage from '../../assets/blog-placeholder-about.jpg';
import { Image } from 'astro:assets';
import IntroEn from '../../components/intro/IntroEn.md';
import IntroPl from '../../components/intro/IntroPl.md';
import ExperienceTimeline from '../../components/ExperienceTimeline.astro';
import TechStack from '../../components/TechStack.astro';
import TechStackPl from '../../components/TechStackPl.astro';
import { getCollection } from 'astro:content';

export function getStaticPaths() {
	return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;

const Intro = lang === 'pl' ? IntroPl : IntroEn;

const experienceEntries = await getCollection('experience', (entry) => {
    return entry.id.startsWith(lang + '/');
});

const sortedExperience = experienceEntries.sort((a, b) => b.data.order - a.data.order);

const experienceData = sortedExperience.map(entry => {
    const { company, role, startDate, endDate } = entry.data;
    const body = entry.body;

    const dateOptions: Intl.DateTimeFormatOptions = { year: 'numeric', month: lang === 'pl' ? 'long' : 'short' };
    
    let finalStart = new Date(startDate).toLocaleDateString(lang === 'pl' ? 'pl-PL' : 'en-US', dateOptions);
    finalStart = finalStart.charAt(0).toUpperCase() + finalStart.slice(1);

    let finalEnd = endDate;
    if (endDate !== 'Present' && endDate !== 'Obecnie') {
         const d = new Date(endDate);
         if (!isNaN(d.getTime())) {
             let formattedEnd = d.toLocaleDateString(lang === 'pl' ? 'pl-PL' : 'en-US', dateOptions);
             finalEnd = formattedEnd.charAt(0).toUpperCase() + formattedEnd.slice(1);
         }
    }

    return {
        company,
        role,
        period: `${finalStart} - ${finalEnd}`,
        description: body ?? ''
    };
});

const content = {
	en: {
        techTitle: "Tech Stack",
        techInstruction: "Hover on tiles below for more context.",
        experienceTitle: "Experience",
	},
	pl: {
        techTitle: "Technologie",
        techInstruction: "Najedź na kafelki poniżej, aby uzyskać więcej informacji",
        experienceTitle: "Doświadczenie",
	}
};

const t = content[lang as keyof typeof content];
---

<Layout
	title={lang === 'pl' ? 'Cześć. Jestem Szymon.' : "Hi. I'm Szymon."}
	description={lang === 'pl' ? 'O mnie' : 'About Me'}
>
    <h1 slot="title">
        {lang === 'pl' ? (
            'Cześć. Jestem Szymon.'
        ) : (
            <>
                Hi. I'm <span class="alternating-name">Szymon.</span>
            </>
        )}
    </h1>

    <div class="about-container">
        <section class="intro fade-in">
            <Image src={aboutImage} alt="Szymon Pucher" class="profile-img" width={300} />
            <div class="lead">
                <Intro />
            </div>
        </section>

        {lang === 'pl' ? (
            <TechStackPl techTitle={t.techTitle} techInstruction={t.techInstruction} />
        ) : (
            <TechStack techTitle={t.techTitle} techInstruction={t.techInstruction} />
        )}

        <section class="experience fade-in delay-3">
            <h3 class="experience-title">{t.experienceTitle}</h3>
            <ExperienceTimeline experience={experienceData} lang={lang} />
        </section>
    </div>
</Layout>

<script>
    const names = ["Szymon.", "Simon."];
    const element = document.querySelector('.alternating-name');
    let nameIndex = 0;

    function animate() {
        if (!element) return;
        
        // Slide out to top
        element.classList.add('slide-out');
        
        setTimeout(() => {
            // Change text
            nameIndex = (nameIndex + 1) % names.length;
            element.textContent = names[nameIndex];
            
            // Prepare for slide in (move to bottom instantly)
            element.classList.remove('slide-out');
            element.classList.add('prepare-slide-in');
            
            // Force reflow
            void (element as HTMLElement).offsetWidth;
            
            // Slide in to center
            element.classList.remove('prepare-slide-in');
        }, 500); // Match transition duration
    }

    // Start animation loop
    setInterval(animate, 3000);
</script>

<style>
    .alternating-name {
        display: inline-block;
        transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        opacity: 1;
        transform: translateY(0);
        width: 4em;
        text-align: left;
    }

    .slide-out {
        transform: translateY(-20px);
        opacity: 0;
    }

    .prepare-slide-in {
        transition: none;
        transform: translateY(20px);
        opacity: 0;
    }
    .about-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .profile-img {
        float: left;
        margin-right: 2rem;
        margin-bottom: 0.5rem;
        border-radius: 12px;
        width: 240px;
        height: auto;
        box-shadow: var(--box-shadow);
    }

    .lead {
        font-size: 0.8em;
        font-weight: 500;
        color: var(--black);
    }

    @media (max-width: 600px) {
        .profile-img {
            float: none;
            display: block;
            margin: 0 auto 1.5rem auto;
            width: 100%;
            max-width: 300px;
        }
    }

    /* Syntax Highlighting Sim */
    .keyword { color: #569cd6; }
    .string { color: #ce9178; }
    .class-name { color: #4ec9b0; }
    .function { color: #dcdcaa; }
    .number { color: #b5cea8; }

    /* Animations */
    .fade-in {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.8s ease-out forwards;
    }
    .delay-1 { animation-delay: 0.3s; }
    .delay-2 { animation-delay: 0.6s; }
    .delay-3 { animation-delay: 0.9s; }

    /* Experience section spacing */
    .experience {
        margin-top: 2rem;
    }
    .experience-title {
        margin-bottom: 1.5rem;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>